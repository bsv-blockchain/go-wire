# ------------------------------------------------------------------------------------
#  Benchmark Suite (Reusable Workflow) (GoFortress)
#
#  Purpose: Run Go benchmarks across multiple Go versions and operating systems,
#  collecting performance metrics for analysis and comparison.
#
#  Maintainer: @mrz1836
#
# ------------------------------------------------------------------------------------
name: GoFortress (Benchmark Suite)
on:
  workflow_call:
    inputs:
      env-json:
        description: "JSON string of environment variables"
        required: true
        type: string
      benchmark-matrix:
        description: "Benchmark matrix JSON"
        required: true
        type: string
      primary-runner:
        description: "Primary runner OS"
        required: true
        type: string
      go-primary-version:
        description: "Primary Go version"
        required: true
        type: string
      go-secondary-version:
        description: "Secondary Go version"
        required: true
        type: string
    secrets:
      github-token:
        description: "GitHub token for API access"
        required: true
permissions:
  contents: read
jobs:
  # ----------------------------------------------------------------------------------
  # Benchmark Matrix for Go (Parallel)
  # ----------------------------------------------------------------------------------
  benchmark-go:
    name: ðŸƒ Benchmark (${{ matrix.name }})
    timeout-minutes: 30 # Prevent hung benchmarks
    strategy:
      fail-fast: false # Continue running other benchmarks if one fails
      matrix: ${{ fromJSON(inputs.benchmark-matrix) }}
    runs-on: ${{ matrix.os }}
    steps:
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Parse environment variables
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ”§ Parse environment variables
        env:
          ENV_JSON: ${{ inputs.env-json }}
        run: |
          echo "ðŸ“‹ Setting environment variables..."
          echo "$ENV_JSON" | jq -r 'to_entries | .[] | "\(.key)=\(.value)"' | while IFS='=' read -r key value; do
            echo "$key=$value" >> $GITHUB_ENV
          done
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Checkout code and set up Go environment
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: ðŸ”§ Set Go cache paths (cross-platform)
        run: |
          echo "ðŸ”§ Setting up Go cache paths..."
          echo "GOCACHE=$HOME/.cache/go-build"        >> $GITHUB_ENV
          echo "GOMODCACHE=$HOME/go/pkg/mod"          >> $GITHUB_ENV
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Restore Go module and build caches
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ’¾ Restore Go module cache
        id: restore-gomod
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: ~/go/pkg/mod
          key: ${{ matrix.os }}-gomod-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ matrix.os }}-gomod-
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Restore the build cache
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ’¾ Restore Go build cache
        id: restore-gobuild
        uses: actions/cache/restore@0057852bfaa89a56745cba8c7296529d2fc39830 # v4.3.0
        with:
          path: |
            ~/.cache/go-build
            ~/.cache/go-build/test
          key: ${{ matrix.os }}-gobuild-${{ matrix.go-version }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ matrix.os }}-gobuild-${{ matrix.go-version }}-
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Check go.mod required version before setting up Go
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ” Check Go version requirement
        id: check-go-version
        shell: bash
        run: |
          if [ -f go.mod ]; then
            REQUIRED_VERSION=$(grep -E '^go\s+[0-9]+\.[0-9]+' go.mod | awk '{print $2}')
            if [ -n "$REQUIRED_VERSION" ]; then
              echo "ðŸ“‹ go.mod requires Go version: $REQUIRED_VERSION"
              echo "required_version=$REQUIRED_VERSION" >> $GITHUB_OUTPUT

              # Extract major.minor from matrix.go-version (handle formats like 1.23.x, 1.23, 1.23.4)
              REQUESTED_VERSION="${{ matrix.go-version }}"
              REQUESTED_MAJOR_MINOR=$(echo "$REQUESTED_VERSION" | grep -oE '^[0-9]+\.[0-9]+')

              # Compare versions
              if [ -n "$REQUESTED_MAJOR_MINOR" ]; then
                # Convert to comparable format (e.g., 1.23 -> 123, 1.9 -> 109)
                REQ_COMPARABLE=$(echo "$REQUIRED_VERSION" | awk -F. '{printf "%d%02d", $1, $2}')
                REQUESTED_COMPARABLE=$(echo "$REQUESTED_MAJOR_MINOR" | awk -F. '{printf "%d%02d", $1, $2}')

                if [ "$REQUESTED_COMPARABLE" -lt "$REQ_COMPARABLE" ]; then
                  echo "âš ï¸ WARNING: Requested Go version (${{ matrix.go-version }}) is older than required ($REQUIRED_VERSION)"
                  echo "version_mismatch=true" >> $GITHUB_OUTPUT
                else
                  echo "âœ… Requested Go version (${{ matrix.go-version }}) meets requirement ($REQUIRED_VERSION)"
                  echo "version_mismatch=false" >> $GITHUB_OUTPUT
                fi
              fi
            fi
          fi
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Determine Go Toolchain Mode and set up Go
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ§® Determine Go Toolchain Mode
        id: toolchain-mode
        shell: bash
        run: |
          # If there's a version mismatch, allow toolchain to auto-upgrade
          if [[ "${{ steps.check-go-version.outputs.version_mismatch }}" == "true" ]]; then
            echo "âš ï¸ Version mismatch detected - allowing Go toolchain to auto-upgrade"
            echo "Not setting GOTOOLCHAIN (using default auto behavior)"
          elif [[ "${{ matrix.go-version }}" == "${{ inputs.go-secondary-version }}" && \
                "${{ matrix.go-version }}" != "${{ inputs.go-primary-version }}" ]]; then
            echo "Setting GOTOOLCHAIN=local"
            echo "GOTOOLCHAIN=local" >> $GITHUB_ENV
          else
            echo "Not setting GOTOOLCHAIN (using default)"
          fi
      - name: ðŸ—ï¸ Set up Go
        id: setup-go-bench
        uses: actions/setup-go@44694675825211faa026b3c33043df3e48a5fa00 # v6.0.0
        with:
          go-version: ${{ matrix.go-version }}
          cache: false # we handle caches ourselves
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Start benchmark timer
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: â±ï¸ Start benchmark timer
        id: bench-timer
        run: |
          echo "bench-start=$(date +%s)" >> $GITHUB_OUTPUT
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Run benchmarks and capture output
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸƒ Run benchmarks
        id: run-benchmarks
        run: |
          echo "ðŸƒ Running benchmarks..."

          # Create output file for raw benchmark results
          BENCH_OUTPUT_FILE="benchmark-results-${{ matrix.os }}-${{ matrix.go-version }}.txt"

          # Run benchmarks and capture output
          if make bench > "$BENCH_OUTPUT_FILE" 2>&1; then
            echo "âœ… Benchmarks completed successfully"
            BENCH_STATUS="success"
          else
            echo "âŒ Benchmarks failed"
            BENCH_STATUS="failure"
          fi

          # Display benchmark output
          echo "ðŸ“Š Benchmark Results:"
          cat "$BENCH_OUTPUT_FILE"

          # Save status for later
          echo "bench_status=$BENCH_STATUS" >> $GITHUB_OUTPUT
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Parse benchmark results and create statistics
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“Š Parse benchmark statistics
        id: bench-summary
        if: always()
        run: "BENCH_END=$(date +%s)\nBENCH_DURATION=$((BENCH_END - ${{ steps.bench-timer.outputs.bench-start }}))\n\n# Count benchmarks\nBENCHMARK_COUNT=$(find . -type f -name '*_test.go' \\\n  -not -path './vendor/*' \\\n  -not -path './third_party/*' \\\n  -exec grep -h '^func Benchmark' {} + | wc -l)\n\n# Parse benchmark results\nBENCH_OUTPUT_FILE=\"benchmark-results-${{ matrix.os }}-${{ matrix.go-version }}.txt\"\nSTATS_FILE=\"benchmark-stats-${{ matrix.os }}-${{ matrix.go-version }}.json\"\n\n# Create a pretty summary of benchmark results\nBENCH_SUMMARY=\"\"\nif [ -f \"$BENCH_OUTPUT_FILE\" ]; then\n  # Step 1: Extract benchmark result lines using a more specific pattern\n  # Expected format: BenchmarkName-N  iterations  ns/op  [B/op]  [allocs/op]\n  # Example: BenchmarkMyFunc-8  1000000  1234.5 ns/op  56 B/op  2 allocs/op\n  \n  # Primary pattern: Match benchmark name with dash-number, iterations, and ns/op\n  BENCH_LINES=$(grep -E '^Benchmark[A-Za-z0-9_-]+-[0-9]+\\s+[0-9]+\\s+[0-9.]+ ns/op' \"$BENCH_OUTPUT_FILE\" || true)\n  \n  if [ -n \"$BENCH_LINES\" ]; then\n    BENCH_SUMMARY=$(echo \"$BENCH_LINES\" | while read -r line; do\n      # Step 2: Parse each component of the benchmark line\n      \n      # Extract benchmark name (remove the -N suffix where N is the GOMAXPROCS)\n      BENCH_NAME=$(echo \"$line\" | awk '{print $1}' | sed 's/-[0-9]*$//')\n      \n      # Extract iteration count (second field)\n      ITERATIONS=$(echo \"$line\" | awk '{print $2}')\n      \n      # Extract nanoseconds per operation (third field)\n      NS_PER_OP=$(echo \"$line\" | awk '{print $3}')\n      \n      # Step 3: Extract optional memory metrics using targeted grep\n      # Look for \"X B/op\" pattern (bytes per operation)\n      B_PER_OP=$(echo \"$line\" | grep -oE '[0-9.]+ B/op' | awk '{print $1}' || echo \"N/A\")\n      \n      # Look for \"X allocs/op\" pattern (allocations per operation)  \n      ALLOCS_PER_OP=$(echo \"$line\" | grep -oE '[0-9.]+ allocs/op' | awk '{print $1}' || echo \"N/A\")\n      \n      # Step 4: Format the summary line\n      echo \"- **$BENCH_NAME**: $NS_PER_OP ns/op, $B_PER_OP B/op, $ALLOCS_PER_OP allocs/op ($ITERATIONS iterations)\"\n    done)\n  fi\nfi\n\n# Escape the summary for JSON\nBENCH_SUMMARY_JSON=$(echo \"$BENCH_SUMMARY\" | jq -Rsa .)\n\n# Create statistics file using jq to safely construct JSON\njq -n \\\n  --arg name \"${{ matrix.name }}\" \\\n  --arg os \"${{ matrix.os }}\" \\\n  --arg go_version \"${{ matrix.go-version }}\" \\\n  --argjson duration_seconds \"$BENCH_DURATION\" \\\n  --argjson benchmark_count \"$BENCHMARK_COUNT\" \\\n  --arg status \"${{ steps.run-benchmarks.outputs.bench_status }}\" \\\n  --arg timestamp \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\" \\\n  --argjson benchmark_summary \"$BENCH_SUMMARY_JSON\" \\\n  '{\n    \"name\": $name,\n    \"os\": $os,\n    \"go_version\": $go_version,\n    \"duration_seconds\": $duration_seconds,\n    \"benchmark_count\": $benchmark_count,\n    \"status\": $status,\n    \"timestamp\": $timestamp,\n    \"benchmark_summary\": $benchmark_summary\n  }' > \"$STATS_FILE\"\n\necho \"ðŸ“Š Benchmark statistics:\"\njq . \"$STATS_FILE\"\n"
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Upload benchmark statistics
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“¤ Upload benchmark statistics
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: benchmark-stats-${{ matrix.os }}-${{ matrix.go-version }}
          path: benchmark-stats-*.json
          retention-days: 1
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      # Upload raw benchmark results
      # â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”â€”
      - name: ðŸ“¤ Upload benchmark results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: benchmark-results-${{ matrix.os }}-${{ matrix.go-version }}
          path: benchmark-results-*.txt
          retention-days: 7 # Keep raw results longer for analysis
